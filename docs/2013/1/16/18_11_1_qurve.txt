I've definitely got the problem solved, now it's just a matter of seeing if I can solve it cleaner.
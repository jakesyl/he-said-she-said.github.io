although the resulting code is really ugly
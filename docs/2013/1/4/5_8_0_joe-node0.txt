Here we go, all the pastie code mangling is cleaned up: http://pastie.org/5619752
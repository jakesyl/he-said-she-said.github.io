I know it doesn't look it, but it's simpler than the old implementation
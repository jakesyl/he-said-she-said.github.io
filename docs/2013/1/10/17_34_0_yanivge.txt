code sample: http://pastie.org/5662811
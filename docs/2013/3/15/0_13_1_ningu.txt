you shouldn't call ws.end, you should listen for ws.on('close'(
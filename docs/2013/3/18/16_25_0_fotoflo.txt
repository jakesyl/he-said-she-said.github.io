Ok, there may be some bracket issues here, but plz ignore them and just look at the conceptual handling of callbacks
you should process.nextTick to simulate asynchronously if you must
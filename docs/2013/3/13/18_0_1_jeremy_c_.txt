I wrote a script to process some EDI files, the reading and parsing of those files takes a little time. Once parsed, I then begin doing pgsql updates. To know when to shut down, I listen to the 'drain' even on the db connection and that works most of the time, but when parsing a large file, the commands to do the file parsing finish before any of them have issued a SQL statement so the app terminates right away. How do you handle these situations?
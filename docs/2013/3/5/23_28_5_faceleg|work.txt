rewrite in perl and that code finished in 10's of minutes
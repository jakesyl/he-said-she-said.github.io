Also it looks like you have two res.end() calls
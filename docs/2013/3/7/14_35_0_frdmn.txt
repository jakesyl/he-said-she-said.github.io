full function: http://pastebin.com/Cwq7E3ww
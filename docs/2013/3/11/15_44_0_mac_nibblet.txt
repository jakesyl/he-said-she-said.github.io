Does anyone know a better way of writing this ? https://gist.github.com/macnibblet/d6fe34211816046aee7b
The fun part is that everything works flawlessly on Linux, except that after everything is done it segfaults
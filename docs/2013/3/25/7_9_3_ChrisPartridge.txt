someprimetime: i'd suggest breaking this stuff out into middleware, and attaching things to req so its available "down stream" so to speak
use process.nextTick or setImmediate
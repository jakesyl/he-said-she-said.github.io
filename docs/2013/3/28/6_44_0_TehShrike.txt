And then 15 minutes later I was working with a less stupid version of the code
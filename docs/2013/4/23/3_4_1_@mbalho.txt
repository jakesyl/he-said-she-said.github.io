d2dchat: i wrote this a while back, it does similar stuff https://gist.github.com/maxogden/1609973
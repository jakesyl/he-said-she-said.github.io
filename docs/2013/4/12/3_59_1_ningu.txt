the logic is fairly intricate
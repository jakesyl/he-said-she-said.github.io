bmatusiak, here is the code http://pastie.org/7371058#
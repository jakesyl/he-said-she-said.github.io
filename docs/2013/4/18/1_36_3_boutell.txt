in that gist I check for errors in either stream, watch out for having already closed stuff due to an error on the other stream, and take care not to double-invoke my callbacks generally
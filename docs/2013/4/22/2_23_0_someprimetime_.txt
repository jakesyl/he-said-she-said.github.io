current algorithm: http://pastebin.com/21he4E2j
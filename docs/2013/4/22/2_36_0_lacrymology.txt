jayk: the code is really very convoluted. Let me see if I can minimize it a bit
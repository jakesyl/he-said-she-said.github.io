without using threads or some nasty hack
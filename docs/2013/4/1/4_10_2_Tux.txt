This is my code: http://pastie.org/7255492
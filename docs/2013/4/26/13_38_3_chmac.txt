I've ended up putting everything in a single function so that return will work.
what's the pattern for performing a series of write -> read (checking the response each time) on a socket?
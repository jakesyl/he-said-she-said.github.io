Ok cool, I'll re-write this as a middleware function and see what happens
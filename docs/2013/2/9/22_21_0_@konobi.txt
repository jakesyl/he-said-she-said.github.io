have a look at how other middleware does it
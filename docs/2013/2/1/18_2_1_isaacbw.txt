here's the whole thing for anyone who's interested: http://hastebin.com/toyiyopaho.vhdl
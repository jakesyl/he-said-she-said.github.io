Hmm, this feels extremely messy https://gist.github.com/macnibblet/6775d2718cb576a1c2cf 
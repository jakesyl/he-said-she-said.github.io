(yes, the code is a tad ugly :)
its almost directly ripped from underscore, from memory anyway
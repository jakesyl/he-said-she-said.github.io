it's a hand-written state machine
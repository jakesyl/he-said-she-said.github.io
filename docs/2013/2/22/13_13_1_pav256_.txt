I've brought it down to this http://pastebin.com/1jpYN3zg (8 sloc).
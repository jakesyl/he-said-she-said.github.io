tpayne: put middleware higher up in the stack?
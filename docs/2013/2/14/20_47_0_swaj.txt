if I new C++ I'd clean this up.  The crypto library needs some love.
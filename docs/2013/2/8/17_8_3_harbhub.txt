how would you refactor that pipe file code?
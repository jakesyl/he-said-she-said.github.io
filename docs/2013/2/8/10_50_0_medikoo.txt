it can be even slightly more simplified, see last line https://gist.github.com/medikoo/4737974
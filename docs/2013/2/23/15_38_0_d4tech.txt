the code is http://pastie.org/6322428 and the error is http://pastie.org/6322416
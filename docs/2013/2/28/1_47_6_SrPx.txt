almost rewritting everything in PHP :(
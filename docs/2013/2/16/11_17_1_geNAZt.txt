but it does not emit end but this should be simple to solve
What's the "right" way to do something like this in node? http://pastebin.com/LAqCu4TS
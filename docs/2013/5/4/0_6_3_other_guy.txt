I'm just using setImmediate to do a non-blocking while loop by faking TCO
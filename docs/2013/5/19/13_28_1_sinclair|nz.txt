ningu: http://pastebin.com/XNaZvhF5 - line 146
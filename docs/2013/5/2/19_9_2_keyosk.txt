Moreover, the bottom, callback(false, metadata) will be empty, because it's firing before the foreach completes
final solution was like 50 LOC
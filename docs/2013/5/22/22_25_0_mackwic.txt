Seems that putting an app.use(check_auth) before app.use(app.router) is not enough
How can I code this better? https://gist.github.com/anonymous/420fca456eeda72c8348
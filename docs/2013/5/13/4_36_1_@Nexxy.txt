it also needs process.nextTick instead of setImmediate
Having a bit of a scoping issue. http://pastie.org/7747558
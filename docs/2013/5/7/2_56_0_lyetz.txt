Could someone help me figure out why this function isn't returning the proper value?
async code inside sync loops = a nightmare
if you want to see some messy code that's sort of like what you want to do here's something I wrote a while back
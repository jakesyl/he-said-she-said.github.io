is this code idiomatic? http://pastie.org/4662933
take a look at lib/stream.js, it's maybe a hundred lines of code
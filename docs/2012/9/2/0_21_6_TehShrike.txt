I would break it up into functions that take data and return other data, instead of modifying this
so set up an async.series or callback chain and move your logic into socket.on('connection')
debug that loop and make sure it only reads oneline until the commit callback happens.  I'm pretty sure thats the issue you were having.
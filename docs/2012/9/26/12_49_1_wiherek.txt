I need to do a foreach loop but have to wait for a callback before handling the next element
thats rewritten from production code, it was around 100 lines before moving to the async stuff
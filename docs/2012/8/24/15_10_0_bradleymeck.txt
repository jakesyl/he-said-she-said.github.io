diverdude: pay attention to the last couple lines : https://gist.github.com/3451844 (also this is written base upon a piece of code that was 7 levels deep before refactoring)
I was trying to rewrite this to be more nodely: http://pastebin.com/svnCQ5ps
maxogden: it's a bit more loc to get it really right for the nested case: https://gist.github.com/3251423
Function is almost 2000 chars using the obfuscator
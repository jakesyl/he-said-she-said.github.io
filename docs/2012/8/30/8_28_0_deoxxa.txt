miblon: you can simplify a bunch of that - check out `request'
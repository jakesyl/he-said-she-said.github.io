I'm having a problem resolving a race condition: http://hastebin.com/daqodicusa.coffee
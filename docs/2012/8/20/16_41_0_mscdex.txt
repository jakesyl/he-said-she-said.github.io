luckyruby: move lines 9-37 into the sock 'end' event handler
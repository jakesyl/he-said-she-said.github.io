upstream: the general rule with cyclic dependencies is that you must set the "exports" *before* requiring anything else
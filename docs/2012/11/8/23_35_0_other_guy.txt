the problem is basically lines 60-70
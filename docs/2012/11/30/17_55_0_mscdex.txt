writing a duplex stream is a pain
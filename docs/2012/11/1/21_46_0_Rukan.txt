see the first block of code in the question I linked
Here's the code: http://pastie.org/5175129
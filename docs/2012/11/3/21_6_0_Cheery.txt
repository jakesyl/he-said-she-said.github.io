I need to implement this: http://bpaste.net/show/55670/
could reduce nesting a lot in the async.js by extracting out in functions, but then would have issues accessing locals
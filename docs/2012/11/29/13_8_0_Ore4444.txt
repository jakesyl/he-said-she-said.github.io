Please check out the following gist:  https://gist.github.com/4168366 (line 526)
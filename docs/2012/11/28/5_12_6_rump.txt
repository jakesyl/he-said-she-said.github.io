https://gist.github.com/4159148  please tell me this is not normal for js control flow... how to be better alternative
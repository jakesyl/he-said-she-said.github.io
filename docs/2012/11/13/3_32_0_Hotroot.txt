Would be simpler if it were a middleware
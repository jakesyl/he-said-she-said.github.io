xp_prg: have a look at https://github.com/caolan/async for managing complex async operations and having them look more like they are working inline
xp_prg: don't be in a loop. register callbacks with apis instead
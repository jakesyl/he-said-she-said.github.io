It's probably a bit dense but here is the S3 code:
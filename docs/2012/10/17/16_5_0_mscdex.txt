Protected: one way is to wrap the function inside the loop that's creating the resource, in a closure and pass the relevant variables in
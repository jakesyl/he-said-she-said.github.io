uh, this code seems to contain lot of global variables
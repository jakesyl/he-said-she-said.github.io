porjo: You can only attach the 'close' event to a socket after the connection has been established (unless you're establishing it manually), so you'll have to store the state at that point
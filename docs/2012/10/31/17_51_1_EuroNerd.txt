I switched a few lines around, but it's basically the same: http://pastie.org/5143987
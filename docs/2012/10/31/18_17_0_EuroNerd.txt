gildean, I think I've stripped it to the core:  http://pastie.org/5144106
now I need to refactor it to follow best practices and have it work reliably
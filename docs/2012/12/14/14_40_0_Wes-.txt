how does socket.end() write data to the socket?  Does it blindly write() and then do a shutdown(fd, SHUT_WR)?   Or does it wait for the "drain" even before the shutdown()?   The docs are not really clear on whether there is a guarantee that the data will be transmitted before the socket is half-closed.
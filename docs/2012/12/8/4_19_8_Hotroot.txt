The project is largeish, but I'll paste the relevant bits
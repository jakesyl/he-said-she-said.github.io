jrajav: https://gist.github.com/b82025717a2510fba57b and http://pastie.org/5557735#
the C++ part of it is almost unmodified directly from node.cc
epic720: here is basically most of our implementation. It has some extra stuff because we use the scopes feature; without that it would be even simpler.
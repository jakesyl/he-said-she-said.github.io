bradleymeck: that's some hairy code that should be split out into a separate module.
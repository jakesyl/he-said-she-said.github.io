it could be a lot better in lua IMO (api) with coros